{
  "meta": {
    "schema_version": "1.1.0",
    "awf_version": "3.3.0",
    "last_updated": "2026-02-14T01:00:00+07:00"
  },
  "project": {
    "name": "claude-remote",
    "type": "fullstack-web",
    "description": "Web-based remote interface for Claude Code CLI, allowing mobile/browser access to Claude Code sessions",
    "status": "active-development",
    "repository": "local"
  },
  "tech_stack": {
    "frontend": {
      "framework": "React 18.3",
      "bundler": "Vite 6",
      "styling": "TailwindCSS 4.0 (CSS-first config)",
      "state": "Zustand 5.0",
      "language": "TypeScript 5.7",
      "markdown": "react-markdown + remark-gfm"
    },
    "backend": {
      "runtime": "Bun",
      "framework": "Elysia 1.2",
      "websocket": "Bun native WebSocket",
      "language": "TypeScript"
    },
    "claude_integration": {
      "primary": "Claude CLI (subprocess)",
      "secondary": "Claude Agent SDK V2 (no API key needed)",
      "pattern": "Provider abstraction layer",
      "note": "Both providers use Claude CLI OAuth auth"
    },
    "architecture": {
      "type": "monorepo",
      "workspaces": [
        "server",
        "client",
        "shared"
      ],
      "communication": "WebSocket (real-time bidirectional)"
    }
  },
  "api_endpoints": {
    "websocket_events": {
      "client_to_server": [
        {
          "type": "auth",
          "params": "token",
          "description": "Authenticate client"
        },
        {
          "type": "message",
          "params": "content",
          "description": "Send message to Claude"
        },
        {
          "type": "project:switch",
          "params": "path",
          "description": "Switch working directory"
        },
        {
          "type": "file:read",
          "params": "path",
          "description": "Read file content"
        },
        {
          "type": "file:list",
          "params": "path",
          "description": "List directory contents"
        },
        {
          "type": "session:list",
          "params": "none",
          "description": "List Claude sessions"
        },
        {
          "type": "session:switch",
          "params": "sessionId",
          "description": "Switch to session"
        },
        {
          "type": "session:resume",
          "params": "sessionId",
          "description": "Resume session"
        },
        {
          "type": "commands:list",
          "params": "none",
          "description": "List slash commands"
        }
      ],
      "server_to_client": [
        {
          "type": "auth:success",
          "data": "user object"
        },
        {
          "type": "auth:error",
          "data": "error message"
        },
        {
          "type": "message:chunk",
          "data": "streaming content + id"
        },
        {
          "type": "message:tool_use",
          "data": "id + toolName + toolInput"
        },
        {
          "type": "message:done",
          "data": "id"
        },
        {
          "type": "message:error",
          "data": "error + id"
        },
        {
          "type": "message:append",
          "data": "full Message object (snapshot)"
        },
        {
          "type": "message:thinking",
          "data": "isThinking boolean"
        },
        {
          "type": "message:thinking_content",
          "data": "id + thinking text"
        },
        {
          "type": "terminal:output",
          "data": "tool output"
        },
        {
          "type": "file:content",
          "data": "path + content"
        },
        {
          "type": "file:tree",
          "data": "path + FileNode tree"
        },
        {
          "type": "project:list",
          "data": "Project[]"
        },
        {
          "type": "project:current",
          "data": "Project"
        },
        {
          "type": "session:list",
          "data": "Session[]"
        },
        {
          "type": "session:current",
          "data": "Session | null"
        },
        {
          "type": "session:info",
          "data": "model + TokenUsage"
        },
        {
          "type": "session:id",
          "data": "sessionId"
        },
        {
          "type": "session:messages",
          "data": "Message[]"
        },
        {
          "type": "commands:list",
          "data": "SlashCommand[]"
        }
      ]
    }
  },
  "features": [
    {
      "name": "Remote Claude Access",
      "status": "implemented",
      "description": "Access Claude Code from any browser/mobile device"
    },
    {
      "name": "Session Management",
      "status": "implemented",
      "description": "List, switch, resume Claude sessions per project"
    },
    {
      "name": "File Explorer",
      "status": "implemented",
      "description": "VS Code-style file tree with 100+ file type icons, collapsed by default"
    },
    {
      "name": "File Viewer",
      "status": "implemented",
      "description": "VS Code-style file viewer with syntax highlighting, line numbers, breadcrumbs, status bar, and zoom (Ctrl+/-)"
    },
    {
      "name": "Real-time Streaming",
      "status": "implemented",
      "description": "Stream Claude responses via WebSocket"
    },
    {
      "name": "Thinking Indicator",
      "status": "implemented",
      "description": "Show Claude extended thinking status with streaming content"
    },
    {
      "name": "Tool Use Display",
      "status": "implemented",
      "description": "Render tool calls and tool results in message stream"
    },
    {
      "name": "Slash Commands Autocomplete",
      "status": "implemented",
      "description": "Autocomplete dropdown for slash commands (builtin/project/user)"
    },
    {
      "name": "Provider Abstraction",
      "status": "implemented",
      "description": "Switch between CLI and SDK backends"
    },
    {
      "name": "iOS Mobile Support",
      "status": "implemented",
      "description": "Touch handlers, UUID fallback for older Safari"
    },
    {
      "name": "Message Copy (Mobile Support)",
      "status": "implemented",
      "description": "Copy message content to clipboard with HTTP fallback"
    },
    {
      "name": "Unified Command UI",
      "status": "implemented",
      "description": "Parse and display encoded command tags as clean UI blocks"
    },
    {
      "name": "Tool Content Popup",
      "status": "implemented",
      "description": "Long tool use/result content is truncated, click to expand in fullscreen modal"
    },
    {
      "name": "AWF Content Filtering",
      "status": "implemented",
      "description": "Strip workflow content (YAML frontmatter, markdown body) from displayed messages"
    },
    {
      "name": "Claude Config Loading",
      "status": "implemented",
      "description": "Load Claude settings from ~/.claude/settings.json and projects from ~/Library/Application Support/Claude/projects/"
    },
    {
      "name": "Project Last Modified",
      "status": "implemented",
      "description": "Calculate project lastModified by scanning all files and picking the latest mtime"
    }
  ],
  "knowledge_items": {
    "patterns": [
      {
        "name": "Provider Pattern",
        "description": "Abstraction layer for Claude integration (CLI vs SDK)",
        "files": [
          "server/src/claude/types.ts",
          "server/src/claude/providers/"
        ]
      },
      {
        "name": "WebSocket Event Bus",
        "description": "Typed bidirectional events via shared/types.ts",
        "files": [
          "shared/types.ts",
          "server/src/websocket.ts",
          "client/src/hooks/useWebSocket.ts"
        ]
      },
      {
        "name": "Zustand Store with useShallow",
        "description": "State management with co-located selector hooks using useShallow to prevent infinite re-renders from object reference comparison",
        "files": [
          "client/src/stores/appStore.ts"
        ]
      },
      {
        "name": "Event Handler Refs (useWebSocket)",
        "description": "Store WebSocket callbacks in refs to avoid stale closures and prevent useCallback recreation on parent re-renders",
        "files": [
          "client/src/hooks/useWebSocket.ts"
        ]
      },
      {
        "name": "Shared Utilities",
        "description": "Extracted shared formatRelativeTime() and truncatePrompt() from ChatPanel and SessionPanel",
        "files": [
          "client/src/utils/format.ts"
        ]
      }
    ],
    "gotchas": [
      {
        "issue": "Copy to clipboard fails on mobile in LAN (HTTP)",
        "solution": "Use legacy document.execCommand('copy') fallback for non-secure contexts",
        "file": "client/src/components/MessageList.tsx"
      },
      {
        "issue": "Stale closure in useCallback causes duplicate messages",
        "solution": "Check for duplicate IDs in Zustand addMessage instead of relying on stale messages array",
        "file": "client/src/stores/appStore.ts"
      },
      {
        "issue": "crypto.randomUUID not available on older iOS Safari",
        "solution": "Fallback to custom UUID generator using Math.random",
        "file": "client/src/App.tsx"
      },
      {
        "issue": "iOS Safari touch events need explicit handlers",
        "solution": "Added onTouchEnd alongside onClick for send button",
        "file": "client/src/components/MessageInput.tsx"
      },
      {
        "issue": "Enter key submits on mobile but prevents multiline input",
        "solution": "Check window width to disable Enter submission on mobile",
        "file": "client/src/components/MessageInput.tsx"
      },
      {
        "issue": "SDK V2 API uses unstable_ prefix",
        "solution": "Use unstable_v2_createSession, unstable_v2_resumeSession - uses same OAuth as CLI",
        "file": "server/src/claude/providers/sdk.ts"
      },
      {
        "issue": "Claude folder naming converts slashes AND underscores to hyphens",
        "solution": "Use regex /[\\/_]/g to match both characters when transforming paths",
        "file": "server/src/services/session.ts"
      },
      {
        "issue": "sessions-index.json may reference deleted session files",
        "solution": "Hybrid discovery: scan filesystem for .jsonl files + index, filter non-existent",
        "file": "server/src/services/session.ts"
      },
      {
        "issue": "ENOENT errors for missing session files are expected, not errors",
        "solution": "Silent error handling with existsSync check before file operations",
        "file": "server/src/services/session.ts"
      },
      {
        "issue": "Streaming messages need both string and ContentBlock[] handling",
        "solution": "updateMessage checks typeof and appends to text block or creates new one",
        "file": "client/src/stores/appStore.ts"
      },
      {
        "issue": "Tool calls and thinking blocks not rendering from SDK stream",
        "solution": "Added onThinkingContent handler and message:thinking_content WebSocket event",
        "files": [
          "server/src/claude/providers/sdk.ts",
          "client/src/App.tsx"
        ]
      },
      {
        "issue": "React StrictMode causes WebSocket disconnect on mount",
        "solution": "Check both OPEN and CONNECTING states before reconnecting, don't close wsRef in cleanup",
        "file": "client/src/hooks/useWebSocket.ts"
      },
      {
        "issue": "Stale closure in handleMessage callback prevents message send",
        "solution": "Use useAppStore.getState().messages instead of closure-captured messages variable",
        "file": "client/src/App.tsx"
      },
      {
        "issue": "tool_use blocks show empty input object",
        "solution": "Parse toolInput from JSON string when creating/appending tool_use blocks",
        "files": [
          "client/src/App.tsx",
          "client/src/stores/appStore.ts"
        ]
      },
      {
        "issue": "Session list not loading after project switch",
        "solution": "Server auto-sends session:list event after project:switch is handled",
        "file": "server/src/websocket.ts"
      },
      {
        "issue": "Duplicate messages in UI from separate onChunk/onToolUse events",
        "solution": "Unified CLI and SDK providers to use 'onMessage' snapshot strategy with 'message:append' event and 'upsertMessage' in store",
        "files": [
          "server/src/claude/providers/sdk.ts",
          "server/src/claude/providers/cli.ts",
          "client/src/stores/appStore.ts"
        ]
      },
      {
        "issue": "AWF workflow content (## User Input, ## Goal) displayed in messages",
        "solution": "Added regex patterns in stripSystemTags to detect @[/workflow] mentions and workflow headings, strip everything after",
        "file": "client/src/components/MessageList.tsx"
      },
      {
        "issue": "Empty message bubble after stripping workflow content",
        "solution": "Check hasVisibleContent before rendering, return null if no text/tools/thinking/images",
        "file": "client/src/components/MessageList.tsx"
      },
      {
        "issue": "Port 5173 conflicts with other apps",
        "solution": "Changed client port to 5555 in vite.config.ts and README.md",
        "files": [
          "client/vite.config.ts",
          "README.md"
        ]
      },
      {
        "issue": "Model display inaccurate (CLI/SDK don't expose model in stream)",
        "solution": "Removed model display from UI entirely (Layout.tsx, MessageInput.tsx)",
        "files": [
          "client/src/components/Layout.tsx",
          "client/src/components/MessageInput.tsx"
        ]
      },
      {
        "issue": "File Explorer showed root folder name unlike VS Code",
        "solution": "Render children directly without root folder wrapper",
        "file": "client/src/components/FileExplorer.tsx"
      },
      {
        "issue": "File icons were generic/boring",
        "solution": "Added 100+ file extensions and 40+ special files with VS Code-like colors and text badges",
        "file": "client/src/components/FileExplorer.tsx"
      },
      {
        "issue": "Folders expanded by default causing clutter",
        "solution": "Changed isOpen default from depth < 2 to false",
        "file": "client/src/components/FileExplorer.tsx"
      },
      {
        "issue": "Zustand selectors returning object literals cause infinite re-render loop",
        "solution": "Wrap all co-located selector hooks with useShallow from zustand/react/shallow",
        "file": "client/src/stores/appStore.ts"
      },
      {
        "issue": "SessionModal flickering during message streaming",
        "solution": "Wrap SessionModal with React.memo, stabilize onClose/onSessionSelect callbacks with useCallback",
        "files": ["client/src/components/ChatPanel.tsx", "client/src/App.tsx"]
      },
      {
        "issue": "useEffect with object dependency causes clientâ†’server infinite loop",
        "solution": "Use primitive dependency (currentProject?.path string) instead of object (currentProject) in useEffect",
        "file": "client/src/App.tsx"
      },
      {
        "issue": "FileExplorer Map constructor uses invalid key:value syntax",
        "solution": "Use new Map(Object.entries({...})) pattern instead of new Map([key, value] pairs)",
        "file": "client/src/components/FileExplorer.tsx"
      },
      {
        "issue": "MessageInput memo() call never closed",
        "solution": "Changed closing } to }); to properly close the memo() wrapper",
        "file": "client/src/components/MessageInput.tsx"
      }
    ],
    "conventions": [
      {
        "rule": "All WebSocket events typed in shared/types.ts",
        "reason": "Type safety between client and server"
      },
      {
        "rule": "Provider implementations in server/src/claude/providers/",
        "reason": "Separation of concerns for Claude backends"
      },
      {
        "rule": "Slash commands discovered from .claude/commands/ and .claude/skills/",
        "reason": "Compatible with Claude Code CLI conventions"
      },
      {
        "rule": "Zustand selectors must use useShallow when returning objects",
        "reason": "Prevents infinite re-render from Object.is reference comparison"
      },
      {
        "rule": "WebSocket callbacks stored in refs (advanced-event-handler-refs pattern)",
        "reason": "Avoids stale closures and unnecessary useCallback recreation"
      },
      {
        "rule": "useEffect dependencies must be primitives, not objects",
        "reason": "Server responses create new object references that trigger effect loops"
      },
      {
        "rule": "Hoist RegExp to module level for functions called repeatedly",
        "reason": "Avoids RegExp creation on every call (js-hoist-regexp pattern)"
      }
    ]
  },
  "file_structure": {
    "server/src/": {
      "index.ts": "Entry point, Elysia server setup",
      "websocket.ts": "WebSocket event handlers",
      "rooms.ts": "WebSocket room management (Pub/Sub)",
      "claude/types.ts": "Provider interface definitions",
      "claude/session.ts": "Session management",
      "claude/providers/cli.ts": "CLI subprocess provider",
      "claude/providers/sdk.ts": "Claude Agent SDK provider",
      "claude/providers/index.ts": "Provider factory",
      "services/commands.ts": "Slash command discovery",
      "services/session.ts": "Session listing and info",
      "services/project.ts": "Project discovery",
      "services/file.ts": "File operations",
      "services/claudeConfig.ts": "Load Claude config from ~/.claude/settings.json",
      "middleware/auth.ts": "Authentication"
    },
    "client/src/": {
      "App.tsx": "Main app component, WebSocket handling",
      "components/Layout.tsx": "Main layout with sidebar, chat, terminal panels",
      "components/AuthScreen.tsx": "Authentication screen",
      "components/MessageInput.tsx": "Chat input with slash command autocomplete",
      "components/MessageList.tsx": "Message display with tool popups, copy, command UI",
      "components/ChatPanel.tsx": "Chat container",
      "components/SessionPanel.tsx": "Session list sidebar",
      "components/ProjectSelector.tsx": "Project switcher dropdown",
      "components/FileExplorer.tsx": "VS Code-style file tree with icons",
      "components/FileViewer.tsx": "VS Code-style file viewer with syntax highlighting, zoom",
      "components/TerminalOutput.tsx": "Terminal output panel",
      "hooks/useWebSocket.ts": "WebSocket hook with auto-reconnect, ref-based callbacks",
      "stores/appStore.ts": "Zustand state store with co-located useShallow selector hooks",
      "utils/format.ts": "Shared utilities: formatRelativeTime(), truncatePrompt()"
    },
    "shared/": {
      "types.ts": "Shared types for WebSocket events and domain models"
    }
  }
}